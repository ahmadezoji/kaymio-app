<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kaymio Affiliate Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  </head>
  <body>
    {% macro preview_hidden_inputs(preview, values) -%}
      <input type="hidden" name="market" value="{{ values.get('market', '') | e }}" />
      <input type="hidden" name="sku_or_url" value="{{ values.get('sku_or_url', '') | e }}" />
      <input type="hidden" name="title" value="{{ preview.title | e }}" />
      <input type="hidden" name="description" value="{{ preview.description | e }}" />
      <input type="hidden" name="affiliate_link" value="{{ values.get('affiliate_link', '') | e }}" />
      <input type="hidden" name="pinterest_extra" value="{{ values.get('pinterest_extra', '') | e }}" />
      <input type="hidden" name="tags" value="{{ preview.tags_payload | e }}" />
      <input type="hidden" name="generated_image_path" value="{{ preview.generated_image_path | e }}" />
      <input type="hidden" name="original_image_path" value="{{ preview.original_image_path | e }}" />
      <input type="hidden" name="instagram_caption" value="{{ preview.instagram_caption | e }}" />
      <input type="hidden" name="instagram_hashtags_payload" value="{{ preview.instagram_hashtags_payload | e }}" />
      <input type="hidden" name="tiktok_caption" value="{{ preview.tiktok_caption | e }}" />
      <input type="hidden" name="tiktok_hashtags_payload" value="{{ preview.tiktok_hashtags_payload | e }}" />
      <input type="hidden" name="youtube_title" value="{{ preview.youtube_title | e }}" />
      <input type="hidden" name="youtube_description" value="{{ preview.youtube_description | e }}" />
      <input type="hidden" name="youtube_keywords_payload" value="{{ preview.youtube_keywords_payload | e }}" />
      <input type="hidden" name="generated_video_path" value="{{ preview.generated_video_path | e }}" />
      <input type="hidden" name="video_prompt" value="{{ preview.video_prompt | e }}" />
      <input type="hidden" name="instagram_image_path" value="{{ preview.instagram_image_path | e }}" />
    {%- endmacro %}
    <div class="page-shell">
      <header class="hero">
        <div>
          <p class="eyebrow">Kaymio Affiliate Studio</p>
          <h1>Launch scroll-stopping pins in minutes.</h1>
          <p class="lede">
            Drop in your marketplace listing, polish the copy, and let the AI workflow craft a
            Pinterest-ready visual + caption combo tailored for your affiliate stores.
          </p>
        </div>
        <div class="hero-pill">
          <span>Multi-market ready</span>
          <span>Gemini visuals</span>
          <span>Pinterest automation</span>
        </div>
      </header>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-stack">
            {% for category, message in messages %}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <main class="layout">
        {% set values = form_values or {} %}
        {% set preview_data = preview or {} %}
        {% set has_preview = preview is not none %}
        <form
          method="post"
          action="{{ url_for('generate_pinterest') }}"
          enctype="multipart/form-data"
          class="grid"
        >
          <section class="card">
            <div class="card-header">
              <h2>Product Data Entry</h2>
              <p>Pick the marketplace and drop in the SKU or URL you want to boost.</p>
            </div>
            <div class="field-grid">
              <label>
                <span>Marketplace</span>
                <div class="input-shell">
                  <select name="market" required>
                    <option value="" disabled {% if not values.get('market') %}selected{% endif %}>
                      Choose a marketplace
                    </option>
                    {% for market in markets %}
                      <option value="{{ market }}" {% if values.get('market') == market %}selected{% endif %}>
                        {{ market }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </label>
              <label>
                <span>SKU / Product Link</span>
                <input
                  name="sku_or_url"
                  placeholder="e.g. SHEIN-329499 or https://..."
                  value="{{ values.get('sku_or_url', '') }}"
                  required
                  type="text"
                />
              </label>
            </div>
            <button type="button" class="ghost-btn" title="Coming soon" disabled>Fetch product data</button>
          </section>

          <section class="card">
            <div class="card-header">
              <h2>Manual product assets</h2>
              <p>Upload a clean product shot when the marketplace does not expose an API.</p>
            </div>
            <label class="dropzone">
              <input type="file" name="product_image" accept="image/*" required />
              <span class="dz-icon">⬆︎</span>
              <p>Drag &amp; drop or click to upload a hero image (PNG, JPG, GIF, WEBP).</p>
            </label>
            <label>
              <span>Product title</span>
              <input
                name="title"
                placeholder="MagSafe-ready Luxury Phone Case"
                value="{{ values.get('title', '') }}"
                required
                type="text"
              />
            </label>
            <label>
              <span>Short description</span>
              <textarea
                name="description"
                placeholder="Add a quick summary or the highlights you love about this listing."
                rows="3"
              >{{ values.get('description', '') }}</textarea>
            </label>
            <label>
              <span>Affiliate link</span>
              <input
                name="affiliate_link"
                placeholder="https://yourstore.com/track?id=..."
                value="{{ values.get('affiliate_link', '') }}"
                required
                type="url"
              />
            </label>
          </section>

          <section class="card">
            <div class="card-header">
              <h2>Pinterest prompt booster</h2>
              <p>Drop any extra angles, seasonal hooks, or CTA copy.</p>
            </div>
            <label>
              <span>Optimization text</span>
              <textarea
                name="pinterest_extra"
                placeholder="Mention eco-friendly materials, Mother's Day bundles, etc."
                rows="3"
              >{{ values.get('pinterest_extra', '') }}</textarea>
            </label>
            <button class="primary" type="submit">Generating for Pinterest</button>
          </section>
        </form>

        <section class="card result">
          <div class="card-header">
            <h2>Review your creative</h2>
            <p>Confirm this hero visual + copy or regenerate another variation before publishing across channels.</p>
          </div>
          {% if has_preview %}
            <div class="preview-grid">
              <div class="preview-image">
                <img src="data:image/png;base64,{{ preview_data.image_data }}" alt="Generated Pinterest pin preview" />
              </div>
              <div class="preview-meta">
                <dl>
                  <dt>Title</dt>
                  <dd>{{ preview_data.title }}</dd>
                  <dt>Description</dt>
                  <dd>{{ preview_data.description }}</dd>
                  {% if preview_data.tags %}
                    <dt>Tags</dt>
                    <dd>
                      {% for tag in preview_data.tags %}
                        <span class="tag">{{ tag }}</span>
                      {% endfor %}
                    </dd>
                  {% endif %}
                </dl>
                <div class="preview-actions">
                  <form method="post" action="{{ url_for('generate_pinterest') }}">
                    <input type="hidden" name="market" value="{{ values.get('market', '') }}" />
                    <input type="hidden" name="sku_or_url" value="{{ values.get('sku_or_url', '') }}" />
                    <input type="hidden" name="title" value="{{ values.get('title', '') }}" />
                    <input type="hidden" name="description" value="{{ values.get('description', '') }}" />
                    <input type="hidden" name="affiliate_link" value="{{ values.get('affiliate_link', '') }}" />
                    <input type="hidden" name="pinterest_extra" value="{{ values.get('pinterest_extra', '') }}" />
                    <input type="hidden" name="original_image_path" value="{{ preview_data.original_image_path }}" />
                    <button type="submit" class="ghost-btn">Regenerate visual</button>
                  </form>
                  <form method="post" action="{{ url_for('confirm_pinterest') }}">
                    {{ preview_hidden_inputs(preview_data, values) }}
                    <button type="submit" class="primary">Confirm &amp; publish to Pinterest</button>
                  </form>
                </div>
              </div>
            </div>
          {% else %}
            <p class="muted">Generate a product visual to unlock publishing on Pinterest, Instagram, TikTok, and YouTube.</p>
          {% endif %}
        </section>
        <section class="card result">
          <div class="card-header">
            <h2>Instagram content</h2>
            <p>Share the same creative on Stories or the feed with platform-ready captions and tags.</p>
          </div>
          <div class="platform-grid">
            <div>
              <h3>Visual</h3>
              {% if has_preview and preview_data.instagram_image_url %}
                <img
                  class="platform-preview"
                  src="{{ preview_data.instagram_image_url }}"
                  alt="Instagram visual preview"
                />
              {% elif has_preview and preview_data.generated_image_url %}
                <img
                  class="platform-preview"
                  src="{{ preview_data.generated_image_url }}"
                  alt="Instagram visual preview"
                />
              {% else %}
                <p class="muted">Generate your first creative to unlock Instagram visuals.</p>
              {% endif %}
              <h3>Caption</h3>
              {% if has_preview %}
                <p class="copy-block">{{ preview_data.instagram_caption | replace('\n', '<br />') | safe }}</p>
              {% else %}
                <p class="copy-block muted">Generate your first creative to see an Instagram-ready caption.</p>
              {% endif %}
              {% if has_preview and preview_data.instagram_hashtags %}
                <h3>Hashtags</h3>
                <div class="tag-tray">
                  {% for tag in preview_data.instagram_hashtags %}
                    <span class="tag">#{{ tag }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            <div class="preview-actions">
              {% if has_preview %}
                <form method="post" action="{{ url_for('generate_instagram_image') }}">
                  {{ preview_hidden_inputs(preview_data, values) }}
                  <input type="hidden" name="instagram_variant" value="feed" />
                  <button type="submit" class="ghost-btn">Generate feed visual</button>
                </form>
                <form method="post" action="{{ url_for('generate_instagram_image') }}">
                  {{ preview_hidden_inputs(preview_data, values) }}
                  <input type="hidden" name="instagram_variant" value="story" />
                  <button type="submit" class="ghost-btn">Generate story visual</button>
                </form>
                <form method="post" action="{{ url_for('publish_instagram') }}">
                  {{ preview_hidden_inputs(preview_data, values) }}
                  <input type="hidden" name="target" value="feed" />
                  <button type="submit" class="primary">Publish to Instagram feed</button>
                </form>
                <form method="post" action="{{ url_for('publish_instagram') }}">
                  {{ preview_hidden_inputs(preview_data, values) }}
                  <input type="hidden" name="target" value="story" />
                  <button type="submit" class="ghost-btn">Share as story</button>
                </form>
              {% else %}
                <button type="button" class="ghost-btn" disabled>Generate feed visual</button>
                <button type="button" class="ghost-btn" disabled>Generate story visual</button>
                <button type="button" class="primary" disabled>Publish to Instagram feed</button>
                <button type="button" class="ghost-btn" disabled>Share as story</button>
              {% endif %}
            </div>
          </div>
        </section>
        <section class="card result">
          <div class="card-header">
            <h2>YouTube Shorts</h2>
            <p>Auto-generate a short-form video, review metadata, and push it straight to YouTube.</p>
          </div>
          <div class="platform-grid">
            <div>
              {% if has_preview and preview_data.video_url %}
                <video controls class="video-preview" src="{{ preview_data.video_url }}"></video>
              {% else %}
                <p class="muted">Use the generate button to create a Short before publishing.</p>
              {% endif %}
              <dl>
                <dt>Title</dt>
                <dd>{{ preview_data.youtube_title if has_preview else 'Awaiting creative...' }}</dd>
                <dt>Description</dt>
                <dd>{{ preview_data.youtube_description if has_preview else 'Generate a product story to see suggested copy.' }}</dd>
                {% if has_preview and preview_data.youtube_keywords %}
                  <dt>Keywords</dt>
                  <dd>
                    {% for keyword in preview_data.youtube_keywords %}
                      <span class="tag">{{ keyword }}</span>
                    {% endfor %}
                  </dd>
                {% endif %}
              </dl>
            </div>
            <div class="preview-actions">
              {% if has_preview %}
                <form method="post" action="{{ url_for('generate_platform_video', platform='youtube') }}">
                  {{ preview_hidden_inputs(preview_data, values) }}
                  <button type="submit" class="ghost-btn">Generate YouTube Short</button>
                </form>
                {% if preview_data.video_url %}
                  <form method="post" action="{{ url_for('publish_youtube') }}">
                    {{ preview_hidden_inputs(preview_data, values) }}
                    <label>
                      <span>Privacy</span>
                      <select name="privacy_status">
                        <option value="public">Public</option>
                        <option value="unlisted" selected>Unlisted</option>
                        <option value="private">Private</option>
                      </select>
                    </label>
                    <button type="submit" class="primary">Publish to YouTube Shorts</button>
                  </form>
                {% else %}
                  <button type="button" class="primary" disabled>Publish to YouTube Shorts</button>
                {% endif %}
              {% else %}
                <button type="button" class="ghost-btn" disabled>Generate YouTube Short</button>
                <button type="button" class="primary" disabled>Publish to YouTube Shorts</button>
              {% endif %}
            </div>
          </div>
        </section>
        <section class="card result">
          <div class="card-header">
            <h2>TikTok drop</h2>
            <p>Leverage the same motion asset and caption to reach TikTok shoppers.</p>
          </div>
          <div class="platform-grid">
            <div>
              <h3>Caption</h3>
                {% if has_preview %}
                <p class="copy-block">{{ preview_data.tiktok_caption | replace('\n', '<br />') | safe }}</p>
              {% else %}
                <p class="copy-block muted">Generate content to unlock TikTok-ready copy and hashtags.</p>
              {% endif %}
              {% if has_preview and preview_data.tiktok_hashtags %}
                <h3>Hashtags</h3>
                <div class="tag-tray">
                  {% for tag in preview_data.tiktok_hashtags %}
                    <span class="tag">#{{ tag }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            <div class="preview-actions">
              {% if has_preview %}
                <form method="post" action="{{ url_for('generate_platform_video', platform='tiktok') }}">
                  {{ preview_hidden_inputs(preview_data, values) }}
                  <button type="submit" class="ghost-btn">Generate TikTok video</button>
                </form>
                {% if preview_data.video_url %}
                  <form method="post" action="{{ url_for('publish_tiktok') }}">
                    {{ preview_hidden_inputs(preview_data, values) }}
                    <label>
                      <span>Privacy</span>
                      <select name="privacy_level">
                        <option value="PUBLIC" selected>Public</option>
                        <option value="FRIENDS">Friends</option>
                        <option value="PRIVATE">Private</option>
                      </select>
                    </label>
                    <button type="submit" class="primary">Publish to TikTok</button>
                  </form>
                {% else %}
                  <button type="button" class="primary" disabled>Publish to TikTok</button>
                {% endif %}
              {% else %}
                <button type="button" class="ghost-btn" disabled>Generate TikTok video</button>
                <button type="button" class="primary" disabled>Publish to TikTok</button>
              {% endif %}
            </div>
          </div>
        </section>

        {% if result %}
          <section class="card result">
            <div class="card-header">
              <h2>Pin ready ✅</h2>
              <p>Gemini visual + Pinterest copy have been dispatched to your board.</p>
            </div>
            <dl>
              <dt>Title</dt>
              <dd>{{ result.title }}</dd>
              <dt>Description</dt>
              <dd>{{ result.description }}</dd>
              {% if result.tags %}
                <dt>Tags</dt>
                <dd>
                  {% for tag in result.tags %}
                    <span class="tag">{{ tag }}</span>
                  {% endfor %}
                </dd>
              {% endif %}
              {% if result.pin_url %}
                <dt>Pin URL</dt>
                <dd><a href="{{ result.pin_url }}" target="_blank" rel="noopener">View on Pinterest</a></dd>
              {% endif %}
            </dl>
          </section>
        {% endif %}
      </main>
    </div>
  </body>
</html>
