<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kaymio Affiliate Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  </head>
  <body>
    {% macro preview_hidden_inputs(preview, values) -%}
      <input type="hidden" name="market" value="{{ values.get('market', '') | e }}" />
      <input type="hidden" name="sku_or_url" value="{{ values.get('sku_or_url', '') | e }}" />
      <input type="hidden" name="title" value="{{ preview.title | e }}" />
      <input type="hidden" name="description" value="{{ preview.description | e }}" />
      <input type="hidden" name="affiliate_link" value="{{ values.get('affiliate_link', '') | e }}" />
      <input type="hidden" name="pinterest_extra" value="{{ values.get('pinterest_extra', '') | e }}" />
      <input type="hidden" name="category" value="{{ values.get('category', '') | e }}" />
      <input type="hidden" name="price" value="{{ values.get('price', '') | e }}" />
      <input type="hidden" name="website_boost_prompt_pref" value="{{ values.get('website_boost_prompt', '') | e }}" />
      <input type="hidden" name="youtube_boost_prompt" value="{{ values.get('youtube_boost_prompt', '') | e }}" />
      <input type="hidden" name="use_affiliate_link_pref" value="{{ values.get('use_affiliate_link', '0') | e }}" />
      <input type="hidden" name="tags" value="{{ preview.tags_payload | e }}" />
      <input type="hidden" name="generated_image_path" value="{{ preview.generated_image_path | e }}" />
      <input type="hidden" name="original_image_path" value="{{ preview.original_image_path | e }}" />
      <input type="hidden" name="instagram_caption" value="{{ preview.instagram_caption | e }}" />
      <input type="hidden" name="instagram_hashtags_payload" value="{{ preview.instagram_hashtags_payload | e }}" />
      <input type="hidden" name="tiktok_caption" value="{{ preview.tiktok_caption | e }}" />
      <input type="hidden" name="tiktok_hashtags_payload" value="{{ preview.tiktok_hashtags_payload | e }}" />
      <input type="hidden" name="youtube_title" value="{{ preview.youtube_title | e }}" />
      <input type="hidden" name="youtube_description" value="{{ preview.youtube_description | e }}" />
      <input type="hidden" name="youtube_keywords_payload" value="{{ preview.youtube_keywords_payload | e }}" />
      <input type="hidden" name="generated_video_path" value="{{ preview.generated_video_path | e }}" />
      <input type="hidden" name="video_prompt" value="{{ preview.video_prompt | e }}" />
      <input type="hidden" name="instagram_image_path" value="{{ preview.instagram_image_path | e }}" />
      <input type="hidden" name="video_duration_seconds" value="{{ preview.video_duration_seconds | default('8') | e }}" />
      <input type="hidden" name="selected_original_image" value="{{ values.get('selected_original_image', '') | e }}" />
    {%- endmacro %}
    {% macro platform_reset_button(platform, label, sku) -%}
      <div class="card-header-actions">
        <form method="post" action="{{ url_for('reset_platform') }}" class="platform-reset">
          <input type="hidden" name="platform" value="{{ platform }}" />
          <input type="hidden" name="sku_or_url" value="{{ sku or '' }}" />
          <button type="submit" class="icon-btn" title="Restart {{ label }}" {% if not sku %}disabled{% endif %}>
            <span aria-hidden="true">+</span>
            <span class="sr-only">Restart {{ label }}</span>
          </button>
        </form>
      </div>
    {%- endmacro %}
    <div class="page-shell">
      <header class="hero">
        <div>
          <p class="eyebrow">Kaymio Affiliate Studio</p>
          <h1>Launch scroll-stopping pins in minutes.</h1>
          <p class="lede">
            Drop in your marketplace listing, polish the copy, and let the AI workflow craft a
            Pinterest-ready visual + caption combo tailored for your affiliate stores.
          </p>
        </div>
        <div class="hero-pill">
          <span>Multi-market ready</span>
          <span>Gemini visuals</span>
          <span>Pinterest automation</span>
        </div>
      </header>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-stack">
            {% for category, message in messages %}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <main class="layout">
        {% set values = form_values or {} %}
        {% set preview_data = preview or {} %}
        {% set has_preview = preview is not none %}
        {% set active_sku = values.get('sku_or_url', '') %}
        {% set use_affiliate_pref = (values.get('use_affiliate_link', '0') or '0') %}
        {% set use_affiliate_checked = use_affiliate_pref|lower in ['1', 'true', 'yes', 'on'] %}
        {% set platform_states = platform_states or {} %}
        {% set pinterest_state = platform_states.get('pinterest', {}) %}
        {% set pinterest_published = pinterest_state.get('status') == 'published' %}
        {% set pinterest_live_url = pinterest_state.get('pin_url') or (result.pin_url if result else '') %}
        {% set website_state = platform_states.get('website', {}) %}
        {% set website_published = website_state.get('status') == 'published' %}
        {% set platforms_locked = not website_published %}
        {% set has_saved_image = preview_data.original_image_path or values.get('original_image_path') %}
        {% set instagram_feed_published = platform_states.get('instagram_feed', {}).get('status') == 'published' %}
        {% set instagram_story_published = platform_states.get('instagram_story', {}).get('status') == 'published' %}
        {% set youtube_published = platform_states.get('youtube', {}).get('status') == 'published' %}
        {% set tiktok_published = platform_states.get('tiktok', {}).get('status') == 'published' %}
        <form method="post" action="{{ url_for('reset_platform') }}" class="card add-card">
          <input type="hidden" name="platform" value="pinterest" />
          <input type="hidden" name="sku_or_url" value="{{ values.get('sku_or_url', '') }}" />
          <div class="card-header add-header">
            <button type="submit" class="ghost-btn add-btn">
              Add +
            </button>
            <span>Start a fresh product workflow.</span>
          </div>
        </form>
        <form
          method="post"
          action="{{ url_for('generate_pinterest') }}"
          enctype="multipart/form-data"
          class="grid"
          id="pinterest-input-form"
        >
          <section class="card">
            <div class="card-header">
              <h2>Product Data Entry</h2>
              <p>Pick the marketplace and drop in the SKU or URL you want to boost.</p>
            </div>
            <div class="field-grid">
              <label>
                <span>Marketplace</span>
                <div class="input-shell">
                  <select name="market" required>
                    <option value="" disabled {% if not values.get('market') %}selected{% endif %}>
                      Choose a marketplace
                    </option>
                    {% for market in markets %}
                      <option value="{{ market }}" {% if values.get('market') == market %}selected{% endif %}>
                        {{ market }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </label>
              <label>
                <span>SKU / Product Link</span>
                <input
                  name="sku_or_url"
                  placeholder="e.g. SHEIN-329499 or https://..."
                  value="{{ values.get('sku_or_url', '') }}"
                  required
                  type="text"
                />
              </label>
            </div>
            <button
              type="submit"
              class="ghost-btn"
              formaction="{{ url_for('fetch_amazon_product') }}"
              formmethod="post"
              formnovalidate
              title="Fetch Amazon product data"
            >
              Fetch product data
            </button>
          </section>
          <input type="hidden" name="use_affiliate_link" value="{{ values.get('use_affiliate_link', '0') }}" />

          <section class="card">
            <div class="card-header">
              <h2>Manual product assets</h2>
              <p>Upload a clean product shot when the marketplace does not expose an API.</p>
            </div>
            <label class="dropzone">
              <input
                type="file"
                name="product_image"
                accept="image/*"
                {% if not has_saved_image %}required{% endif %}
              />
              <span class="dz-icon">⬆︎</span>
              <p>Drag &amp; drop or click to upload a hero image (PNG, JPG, GIF, WEBP).</p>
            </label>
            {% if product_image_choices %}
              <div class="product-gallery">
                <p>Product images</p>
                <div class="product-gallery-grid">
                  {% for image_choice in product_image_choices %}
                    <label class="product-gallery-item">
                      <input
                        type="radio"
                        name="selected_original_image"
                        value="{{ image_choice.value }}"
                        {% if image_choice.value == selected_original_image or loop.first %}checked{% endif %}
                      />
                      <img src="{{ image_choice.url }}" alt="Product image {{ loop.index }}" loading="lazy" />
                    </label>
                  {% endfor %}
                </div>
                <p class="muted">Pick the original image to use for Pinterest, Instagram, and video generation.</p>
              </div>
            {% endif %}
            <label>
              <span>Product title</span>
              <input
                name="title"
                placeholder="MagSafe-ready Luxury Phone Case"
                value="{{ values.get('title', '') }}"
                required
                type="text"
              />
            </label>
            <label>
              <span>Short description</span>
              <textarea
                name="description"
                placeholder="Add a quick summary or the highlights you love about this listing."
                rows="3"
              >{{ values.get('description', '') }}</textarea>
            </label>
            <label>
              <span>Category</span>
              <input
                name="category"
                placeholder="e.g. Accessories, Dresses, Gadgets"
                value="{{ values.get('category', '') }}"
                type="text"
              />
            </label>
            <label>
              <span>Price</span>
              <input
                name="price"
                placeholder="$39.00"
                value="{{ values.get('price', '') }}"
                type="text"
              />
            </label>
            <label>
              <span>Affiliate link</span>
              <input
                name="affiliate_link"
                placeholder="https://yourstore.com/track?id=..."
                value="{{ values.get('affiliate_link', '') }}"
                required
                type="url"
              />
            </label>
            <div class="button-row">
              <button
                type="submit"
                class="ghost-btn"
                formaction="{{ url_for('save_draft') }}"
                formnovalidate
              >
                Save
              </button>
            </div>
          </section>

        </form>

        <section class="card result">
          <div class="card-header">
            <div class="card-header-text">
              <h2>Website content</h2>
              <p>Ship the AI-polished assets to Kaymio.com and capture the canonical product URL.</p>
            </div>
          </div>
          <div class="platform-grid">
            <div>
              <h3>Product snapshot</h3>
              <dl>
                <dt>Title</dt>
                <dd>{{ preview_data.title if has_preview else values.get('title', 'Awaiting creative...') }}</dd>
                <dt>Price</dt>
                <dd>{{ values.get('price', '') or 'Add a price to sync with Kaymio' }}</dd>
                <dt>Category</dt>
                <dd>{{ values.get('category', '') or 'Add a category to improve mapping' }}</dd>
                <dt>Affiliate link</dt>
                <dd>{{ values.get('affiliate_link', '') or 'Add your affiliate link above' }}</dd>
              </dl>
              {% if website_result and website_result.product_url %}
                <p class="muted">
                  Live product URL:
                  <a href="{{ website_result.product_url }}" target="_blank" rel="noopener">
                    {{ website_result.product_url }}
                  </a>
                </p>
              {% elif website_published %}
                <p class="muted">Product URL ready. Reset the workflow if you need to republish.</p>
              {% else %}
                <p class="muted">Publish to generate a Kaymio-hosted product URL.</p>
              {% endif %}
            </div>
            <div class="preview-actions">
              {% if website_published %}
                <p class="muted">Product already live on Kaymio. Reset the product if you need to update details.</p>
                <label>
                  <span>Boost prompt</span>
                  <textarea rows="3" disabled>{{ values.get('website_boost_prompt', '') }}</textarea>
                </label>
                <button type="button" class="primary" disabled>Published</button>
              {% else %}
                <form method="post" action="{{ url_for('publish_website') }}" class="publish-website-form">
                  {% if has_preview %}
                    {{ preview_hidden_inputs(preview_data, values) }}
                  {% else %}
                    <input type="hidden" name="market" value="{{ values.get('market', '') }}" />
                    <input type="hidden" name="sku_or_url" value="{{ values.get('sku_or_url', '') }}" />
                    <input type="hidden" name="title" value="{{ values.get('title', '') }}" />
                    <input type="hidden" name="description" value="{{ values.get('description', '') }}" />
                    <input type="hidden" name="affiliate_link" value="{{ values.get('affiliate_link', '') }}" />
                    <input type="hidden" name="category" value="{{ values.get('category', '') }}" />
                    <input type="hidden" name="price" value="{{ values.get('price', '') }}" />
                    <input type="hidden" name="original_image_path" value="" />
                    <input type="hidden" name="generated_image_path" value="" />
                  {% endif %}
                  <label>
                    <span>Boost prompt</span>
                    <textarea
                      name="website_boost_prompt"
                      placeholder="Add merchandising notes, shipping perks, bonus bundle ideas..."
                      rows="3"
                    >{{ values.get('website_boost_prompt', '') }}</textarea>
                  </label>
                  <button type="submit" class="primary">Publish to Kaymio website</button>
                </form>
                {% if not has_preview %}
                  <p class="muted">Tip: the publish action is available right away—running the generator simply gives you richer copy and media.</p>
                {% endif %}
              {% endif %}
            </div>
          </div>
        </section>

        <section class="card result">
          <div class="card-header">
            <div class="card-header-text">
              <h2>Pinterest content</h2>
              <p>Review your creative, publish to Pinterest, and track the live pin in one place.</p>
            </div>
            {{ platform_reset_button('pinterest', 'Pinterest workflow', active_sku) }}
          </div>
           <div class="prompt-booster">
            <h3>Pinterest prompt booster</h3>
            <p>Drop any extra angles, seasonal hooks, or CTA copy.</p>
            <label>
              <span>Optimization text</span>
              <textarea
                name="pinterest_extra"
                placeholder="Mention eco-friendly materials, Mother's Day bundles, etc."
                rows="3"
                form="pinterest-input-form"
              >{{ values.get('pinterest_extra', '') }}</textarea>
            </label>

            
            <div class="button-row">
              <button
              class="primary"
              type="submit"
              form="pinterest-input-form"
              formaction="{{ url_for('generate_pinterest') }}"
              formmethod="post"
              {% if platforms_locked or pinterest_published %}disabled{% endif %}
              >
              Generating for Pinterest
              </button>
            </div>
          
          </div>
          {% if has_preview %}
            <div class="preview-grid">
              <div class="preview-image">
                <img src="data:image/png;base64,{{ preview_data.image_data }}" alt="Generated Pinterest pin preview" />
              </div>
              <div class="preview-meta">
                <dl>
                  <dt>Title</dt>
                  <dd>{{ preview_data.title }}</dd>
                  <dt>Description</dt>
                  <dd>{{ preview_data.description }}</dd>
                  {% if preview_data.tags %}
                    <dt>Tags</dt>
                    <dd>
                      {% for tag in preview_data.tags %}
                        <span class="tag">{{ tag }}</span>
                      {% endfor %}
                    </dd>
                  {% endif %}
                </dl>
              <div class="preview-actions">
                {% if platforms_locked %}
                  <p class="muted">Publish to Kaymio website first to unlock Pinterest automation.</p>
                  <button type="button" class="ghost-btn" disabled>Regenerate visual</button>
                  <button type="button" class="primary" disabled>Confirm &amp; publish to Pinterest</button>
                {% elif pinterest_published %}
                  <p class="muted">This SKU is already live on Pinterest. Reset the workflow to create another pin.</p>
                  {% if pinterest_live_url %}
                    <p>
                        <a href="{{ pinterest_live_url }}" target="_blank" rel="noopener">View published pin</a>
                      </p>
                    {% endif %}
                    <button type="button" class="primary" {% if pinterest_published %}disabled{% endif %}>Published to Pinterest</button>
                  {% else %}
                    <form method="post" action="{{ url_for('generate_pinterest') }}">
                      <input type="hidden" name="market" value="{{ values.get('market', '') }}" />
                      <input type="hidden" name="sku_or_url" value="{{ values.get('sku_or_url', '') }}" />
                      <input type="hidden" name="title" value="{{ values.get('title', '') }}" />
                      <input type="hidden" name="description" value="{{ values.get('description', '') }}" />
                      <input type="hidden" name="affiliate_link" value="{{ values.get('affiliate_link', '') }}" />
                      <input type="hidden" name="pinterest_extra" value="{{ values.get('pinterest_extra', '') }}" />
                      <input type="hidden" name="original_image_path" value="{{ preview_data.original_image_path }}" />
                      <input type="hidden" name="category" value="{{ values.get('category', '') }}" />
                      <input type="hidden" name="price" value="{{ values.get('price', '') }}" />
                      <input type="hidden" name="website_boost_prompt_pref" value="{{ values.get('website_boost_prompt', '') }}" />
                      <input type="hidden" name="youtube_boost_prompt" value="{{ values.get('youtube_boost_prompt', '') }}" />
                      <input type="hidden" name="use_affiliate_link_pref" value="{{ values.get('use_affiliate_link', '1') }}" />
                      <button type="submit" class="ghost-btn">Regenerate visual</button>
                    </form>
                    <form method="post" action="{{ url_for('confirm_pinterest') }}" id="pinterest-publish-form">
                      {{ preview_hidden_inputs(preview_data, values) }}
                      <input type="hidden" name="use_affiliate_link" value="0" />
                      <label class="checkbox">
                        <input
                          type="checkbox"
                          name="use_affiliate_link"
                          value="1"
                          {% if use_affiliate_checked %}checked{% endif %}
                        />
                        <span>Use affiliate link</span>
                      </label>
                      <button type="submit" class="primary">Confirm &amp; publish to Pinterest</button>
                    </form>
                {% endif %}
              </div>
            </div>
          </div>
            {% if result %}
              <div class="pin-result">
                <h3>Pin details</h3>
                <dl>
                  <dt>Title</dt>
                  <dd>{{ result.title }}</dd>
                  <dt>Description</dt>
                  <dd>{{ result.description }}</dd>
                  {% if result.tags %}
                    <dt>Tags</dt>
                    <dd>
                      {% for tag in result.tags %}
                        <span class="tag">{{ tag }}</span>
                      {% endfor %}
                    </dd>
                  {% endif %}
                  {% if pinterest_live_url %}
                    <dt>Pin URL</dt>
                    <dd><a href="{{ pinterest_live_url }}" target="_blank" rel="noopener">View on Pinterest</a></dd>
                  {% endif %}
                </dl>
              </div>
            {% endif %}
          {% else %}
            <p class="muted">Generate a product visual to unlock publishing on Pinterest, Instagram, TikTok, and YouTube.</p>
            {% if pinterest_published and pinterest_live_url %}
              <p>
                <a href="{{ pinterest_live_url }}" target="_blank" rel="noopener">View published pin</a>
              </p>
            {% endif %}
            <label class="checkbox">
              <input type="checkbox" disabled />
              <span>Use affiliate link</span>
            </label>
          {% endif %}
         
        </section>

        <section class="card result">
          <div class="card-header">
            <div class="card-header-text">
              <h2>Instagram content</h2>
              <p>Share the same creative on Stories or the feed with platform-ready captions and tags.</p>
            </div>
            {{ platform_reset_button('instagram', 'Instagram content', active_sku) }}
          </div>
          <div class="platform-grid">
            <div>
              <h3>Visual</h3>
              {% if has_preview and preview_data.instagram_image_url %}
                <img
                  class="platform-preview"
                  src="{{ preview_data.instagram_image_url }}"
                  alt="Instagram visual preview"
                />
              {% elif has_preview and preview_data.generated_image_url %}
                <img
                  class="platform-preview"
                  src="{{ preview_data.generated_image_url }}"
                  alt="Instagram visual preview"
                />
              {% else %}
                <p class="muted">Generate your first creative to unlock Instagram visuals.</p>
              {% endif %}
              <h3>Caption</h3>
              {% if has_preview %}
                <p class="copy-block">{{ preview_data.instagram_caption | replace('\n', '<br />') | safe }}</p>
              {% else %}
                <p class="copy-block muted">Generate your first creative to see an Instagram-ready caption.</p>
              {% endif %}
              {% if has_preview and preview_data.instagram_hashtags %}
                <h3>Hashtags</h3>
                <div class="tag-tray">
                  {% for tag in preview_data.instagram_hashtags %}
                    <span class="tag">#{{ tag }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            <div class="preview-actions">
              {% if platforms_locked %}
                <p class="muted">Publish to Kaymio website first to unlock Instagram workflows.</p>
              {% endif %}
              {% if has_preview %}
                <form method="post" action="{{ url_for('generate_instagram_image') }}">
                  {{ preview_hidden_inputs(preview_data, values) }}
                  <input type="hidden" name="instagram_variant" value="feed" />
                  <button
                    type="submit"
                    class="ghost-btn"
                    {% if instagram_feed_published or platforms_locked %}disabled{% endif %}
                  >
                    Generate feed visual
                  </button>
                </form>
                <form method="post" action="{{ url_for('generate_instagram_image') }}">
                  {{ preview_hidden_inputs(preview_data, values) }}
                  <input type="hidden" name="instagram_variant" value="story" />
                  <button
                    type="submit"
                    class="ghost-btn"
                    {% if instagram_story_published or platforms_locked %}disabled{% endif %}
                  >
                    Generate story visual
                  </button>
                </form>
              {% else %}
                <p class="muted">Generate visuals to unlock Instagram-specific formats.</p>
              {% endif %}
              <form method="post" action="{{ url_for('publish_instagram') }}">
                {{ preview_hidden_inputs(preview_data, values) }}
                <input type="hidden" name="use_affiliate_link" value="0" />
                <label class="checkbox">
                  <input
                    type="checkbox"
                    name="use_affiliate_link"
                    value="1"
                    {% if use_affiliate_checked %}checked{% endif %}
                    {% if platforms_locked %}disabled{% endif %}
                  />
                  <span>Use affiliate link</span>
                </label>
                <div class="button-row">
                  <button
                    type="submit"
                    class="primary"
                    name="target"
                    value="feed"
                    {% if instagram_feed_published or platforms_locked %}disabled{% endif %}
                  >
                    Publish to Instagram feed
                  </button>
                  <button
                    type="submit"
                    class="ghost-btn"
                    name="target"
                    value="story"
                    {% if instagram_story_published or platforms_locked %}disabled{% endif %}
                  >
                    Share as story
                  </button>
                </div>
                {% if instagram_feed_published or instagram_story_published %}
                  <p class="muted">
                    {% if instagram_feed_published and instagram_story_published %}
                      Instagram feed and story already published.
                    {% elif instagram_feed_published %}
                      Instagram feed already published.
                    {% else %}
                      Instagram story already published.
                    {% endif %}
                  </p>
                {% endif %}
                {% if not has_preview %}
                  <p class="muted">Publishing without a generated creative may fail until assets exist.</p>
                {% elif platforms_locked %}
                  <p class="muted">Finish publishing to Kaymio website before posting on Instagram.</p>
                {% endif %}
              </form>
            </div>
          </div>
        </section>
        <section class="card result">
          <div class="card-header">
            <div class="card-header-text">
              <h2>YouTube Shorts</h2>
              <p>Auto-generate a short-form video, review metadata, and push it straight to YouTube.</p>
            </div>
            {{ platform_reset_button('youtube', 'YouTube workflow', active_sku) }}
          </div>
          <div class="platform-grid">
            <div>
              {% if has_preview and preview_data.video_url %}
                <video controls class="video-preview" src="{{ preview_data.video_url }}"></video>
              {% else %}
                <p class="muted">Use the generate button to create a Short before publishing.</p>
              {% endif %}
              <dl>
                <dt>Title</dt>
                <dd>{{ preview_data.youtube_title if has_preview else 'Awaiting creative...' }}</dd>
                <dt>Description</dt>
                <dd>{{ preview_data.youtube_description if has_preview else 'Generate a product story to see suggested copy.' }}</dd>
                {% if has_preview and preview_data.youtube_keywords %}
                  <dt>Keywords</dt>
                  <dd>
                    {% for keyword in preview_data.youtube_keywords %}
                      <span class="tag">{{ keyword }}</span>
                    {% endfor %}
                  </dd>
                {% endif %}
              </dl>
            </div>
            <div class="preview-actions">
              {% if platforms_locked %}
                <p class="muted">Publish to Kaymio website first to unlock YouTube automation.</p>
              {% endif %}
              {% if has_preview %}
                <form method="post" action="{{ url_for('generate_platform_video', platform='youtube') }}">
                  <label>
                    <span>Short duration (seconds)</span>
                    <input
                      type="number"
                      name="video_duration_seconds"
                      min="4"
                      max="60"
                      step="1"
                      value="{{ preview_data.video_duration_seconds or 8 }}"
                      {% if youtube_published or platforms_locked %}disabled{% endif %}
                    />
                  </label>
                  {% set youtube_boost_pref = values.get('youtube_boost_prompt', '') %}
                  {% if not youtube_boost_pref %}
                    {% set youtube_boost_pref = preview_data.youtube_boost_prompt | default('', true) %}
                  {% endif %}
                  <label>
                    <span>Boost prompt</span>
                    <textarea
                      name="youtube_boost_prompt"
                      placeholder="Provide reassurance about safe content: e.g., no logos, no celebrities, wholesome styling notes..."
                      rows="3"
                      {% if youtube_published or platforms_locked %}disabled{% endif %}
                    >{{ youtube_boost_pref }}</textarea>
                  </label>
                  <p class="muted">
                    Tip: remind Gemini the footage is brand-safe (e.g., “feature a generic model wearing this stylish jacket, no logos visible”).
                  </p>
                  {{ preview_hidden_inputs(preview_data, values) }}
                  <button type="submit" class="ghost-btn" {% if youtube_published or platforms_locked %}disabled{% endif %}>
                    Generate YouTube Short
                  </button>
                </form>
              {% else %}
                <p class="muted">Generate a Short to get AI-crafted video assets before publishing.</p>
              {% endif %}
              {% if preview_data.video_url %}
                <form method="post" action="{{ url_for('publish_youtube') }}">
                  {{ preview_hidden_inputs(preview_data, values) }}
                  <input type="hidden" name="use_affiliate_link" value="0" />
                  <label class="checkbox">
                    <input
                      type="checkbox"
                      name="use_affiliate_link"
                      value="1"
                      {% if use_affiliate_checked %}checked{% endif %}
                      {% if platforms_locked %}disabled{% endif %}
                    />
                    <span>Use affiliate link</span>
                  </label>
                  <label>
                    <span>Privacy</span>
                    <select name="privacy_status">
                      <option value="public" selected>Public</option>
                      <option value="unlisted">Unlisted</option>
                      <option value="private">Private</option>
                    </select>
                  </label>
                  <button type="submit" class="primary" {% if youtube_published or platforms_locked %}disabled{% endif %}>
                    Publish to YouTube Shorts
                  </button>
                </form>
                {% if youtube_published %}
                  <p class="muted">YouTube Short already published.</p>
                {% elif platforms_locked %}
                  <p class="muted">Finish publishing to Kaymio website before posting on YouTube.</p>
                {% endif %}
              {% else %}
                <label class="checkbox">
                  <input type="checkbox" disabled />
                  <span>Use affiliate link</span>
                </label>
                <button type="button" class="primary" disabled>Publish to YouTube Shorts</button>
                <p class="muted">Generate and store a video before publishing.</p>
              {% endif %}
            </div>
          </div>
        </section>
        <section class="card result">
          <div class="card-header">
            <div class="card-header-text">
              <h2>TikTok drop</h2>
              <p>Leverage the same motion asset and caption to reach TikTok shoppers.</p>
            </div>
            {{ platform_reset_button('tiktok', 'TikTok workflow', active_sku) }}
          </div>
          <div class="platform-grid">
            <div>
              <h3>Caption</h3>
                {% if has_preview %}
                <p class="copy-block">{{ preview_data.tiktok_caption | replace('\n', '<br />') | safe }}</p>
              {% else %}
                <p class="copy-block muted">Generate content to unlock TikTok-ready copy and hashtags.</p>
              {% endif %}
              {% if has_preview and preview_data.tiktok_hashtags %}
                <h3>Hashtags</h3>
                <div class="tag-tray">
                  {% for tag in preview_data.tiktok_hashtags %}
                    <span class="tag">#{{ tag }}</span>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
            <div class="preview-actions">
              {% if platforms_locked %}
                <p class="muted">Publish to Kaymio website first to unlock TikTok automation.</p>
              {% endif %}
              {% if has_preview %}
                <form method="post" action="{{ url_for('generate_platform_video', platform='tiktok') }}">
                  {{ preview_hidden_inputs(preview_data, values) }}
                  <button type="submit" class="ghost-btn" {% if tiktok_published or platforms_locked %}disabled{% endif %}>
                    Generate TikTok video
                  </button>
                </form>
              {% else %}
                <p class="muted">Generate a Shorts-style video before sending it to TikTok.</p>
              {% endif %}
              {% if preview_data.video_url %}
                <form method="post" action="{{ url_for('publish_tiktok') }}">
                  {{ preview_hidden_inputs(preview_data, values) }}
                  <input type="hidden" name="use_affiliate_link" value="0" />
                  <label class="checkbox">
                    <input
                      type="checkbox"
                      name="use_affiliate_link"
                      value="1"
                      {% if use_affiliate_checked %}checked{% endif %}
                      {% if platforms_locked %}disabled{% endif %}
                    />
                    <span>Use affiliate link</span>
                  </label>
                  <label>
                    <span>Privacy</span>
                    <select name="privacy_level">
                      <option value="PUBLIC" selected>Public</option>
                      <option value="FRIENDS">Friends</option>
                      <option value="PRIVATE">Private</option>
                    </select>
                  </label>
                  <button type="submit" class="primary" {% if tiktok_published or platforms_locked %}disabled{% endif %}>
                    Publish to TikTok
                  </button>
                </form>
                {% if tiktok_published %}
                  <p class="muted">TikTok video already published.</p>
                {% elif platforms_locked %}
                  <p class="muted">Finish publishing to Kaymio website before posting on TikTok.</p>
                {% endif %}
              {% else %}
                <label class="checkbox">
                  <input type="checkbox" disabled />
                  <span>Use affiliate link</span>
                </label>
                <button type="button" class="primary" disabled>Publish to TikTok</button>
                <p class="muted">Generate and store a TikTok-ready video before publishing.</p>
              {% endif %}
            </div>
          </div>
        </section>

      </main>
    </div>
  </body>
</html>
