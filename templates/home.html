<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Kaymio Affiliate Studio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
  </head>
  <body>
    {% macro preview_hidden_inputs(preview, values, assets) -%}
      {% set preview = preview or {} %}
      {% set assets = assets or {} %}
      <input type="hidden" name="market" value="{{ preview.get('market', values.get('market', '')) | e }}" />
      <input type="hidden" name="sku_or_url" value="{{ preview.get('sku_or_url', values.get('sku_or_url', '')) | e }}" />
      <input type="hidden" name="title" value="{{ preview.get('title', values.get('title', '')) | e }}" />
      <input type="hidden" name="description" value="{{ preview.get('description', values.get('description', '')) | e }}" />
      <input type="hidden" name="affiliate_link" value="{{ preview.get('affiliate_link', values.get('affiliate_link', '')) | e }}" />
      <input type="hidden" name="pinterest_extra" value="{{ preview.get('pinterest_extra', values.get('pinterest_extra', '')) | e }}" />
      <input type="hidden" name="instagram_extra" value="{{ preview.get('instagram_extra', values.get('instagram_extra', '')) | e }}" />
      <input type="hidden" name="youtube_extra" value="{{ preview.get('youtube_extra', values.get('youtube_extra', '')) | e }}" />
      <input type="hidden" name="tiktok_extra" value="{{ preview.get('tiktok_extra', values.get('tiktok_extra', '')) | e }}" />
      <input type="hidden" name="tags" value="{{ preview.get('tags_payload', '') | e }}" />
      {% set generated_path = preview.get('generated_image_path', assets.get('generated_image_path', '')) %}
      <input type="hidden" name="generated_image_path" value="{{ generated_path | e }}" />
      {% set original_path = preview.get('original_image_path', assets.get('original_image_path', '')) %}
      <input type="hidden" name="original_image_path" value="{{ original_path | e }}" />
      <input type="hidden" name="instagram_caption" value="{{ preview.get('instagram_caption', '') | e }}" />
      <input type="hidden" name="instagram_hashtags_payload" value="{{ preview.get('instagram_hashtags_payload', '') | e }}" />
      <input type="hidden" name="tiktok_caption" value="{{ preview.get('tiktok_caption', '') | e }}" />
      <input type="hidden" name="tiktok_hashtags_payload" value="{{ preview.get('tiktok_hashtags_payload', '') | e }}" />
      <input type="hidden" name="youtube_title" value="{{ preview.get('youtube_title', values.get('title', '')) | e }}" />
      <input type="hidden" name="youtube_description" value="{{ preview.get('youtube_description', values.get('description', '')) | e }}" />
      <input type="hidden" name="youtube_keywords_payload" value="{{ preview.get('youtube_keywords_payload', '') | e }}" />
      <input type="hidden" name="generated_video_path" value="{{ preview.get('generated_video_path', assets.get('generated_video_path', '')) | e }}" />
      <input type="hidden" name="video_prompt" value="{{ preview.get('video_prompt', '') | e }}" />
      <input type="hidden" name="instagram_image_path" value="{{ preview.get('instagram_image_path', assets.get('instagram_image_path', '')) | e }}" />
    {%- endmacro %}
    {% macro platform_reset_button(platform, label, sku) -%}
      <div class="card-header-actions">
        <form method="post" action="{{ url_for('reset_platform') }}" class="platform-reset">
          <input type="hidden" name="platform" value="{{ platform }}" />
          <input type="hidden" name="sku_or_url" value="{{ sku or '' }}" />
          <button type="submit" class="icon-btn" title="Restart {{ label }}" {% if not sku %}disabled{% endif %}>
            <span aria-hidden="true">+</span>
            <span class="sr-only">Restart {{ label }}</span>
          </button>
        </form>
      </div>
    {%- endmacro %}
    <div class="page-shell">
      <header class="hero">
        <div>
          <p class="eyebrow">Kaymio Affiliate Studio</p>
          <h1>Launch scroll-stopping pins in minutes.</h1>
          <p class="lede">
            Drop in your marketplace listing, polish the copy, and let the AI workflow craft a
            Pinterest-ready visual + caption combo tailored for your affiliate stores.
          </p>
        </div>
        <div class="hero-pill">
          <span>Multi-market ready</span>
          <span>Gemini visuals</span>
          <span>Pinterest automation</span>
        </div>
      </header>

      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="flash-stack">
            {% for category, message in messages %}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <main class="layout">
        {% set values = form_values or {} %}
        {% set preview_data = preview or {} %}
        {% set has_preview = preview is not none %}
        {% set active_sku = values.get('sku_or_url', '') %}
        {% set state_snapshot = product_state or {} %}
        {% set saved_assets = state_snapshot.get('assets', {}) %}
        {% set base_image_available = preview_data.generated_image_path or preview_data.original_image_path or saved_assets.get('generated_image_path') or saved_assets.get('original_image_path') %}
        {% set instagram_image_available = preview_data.instagram_image_path or saved_assets.get('instagram_image_path') %}
        {% set video_available = preview_data.generated_video_path or saved_assets.get('generated_video_path') %}
        {% set video_seed_available = preview_data.instagram_image_path or saved_assets.get('instagram_image_path') or preview_data.generated_image_path or saved_assets.get('generated_image_path') %}
        {% set has_sku = active_sku %}
        {% set instagram_generation_enabled = has_sku and base_image_available %}
        {% set instagram_publish_ready = has_sku and instagram_image_available %}
        {% set video_generation_enabled = has_sku and video_seed_available %}
        {% set youtube_publish_ready = has_sku and video_available %}
        {% set tiktok_publish_ready = has_sku and video_available %}
        <form
          method="post"
          action="{{ url_for('generate_pinterest') }}"
          enctype="multipart/form-data"
          class="grid"
        >
          <section class="card">
            <div class="card-header">
              <h2>Product Data Entry</h2>
              <p>Pick the marketplace and drop in the SKU or URL you want to boost.</p>
            </div>
            <div class="field-grid">
              <label>
                <span>Marketplace</span>
                <div class="input-shell">
                  <select name="market" required>
                    <option value="" disabled {% if not values.get('market') %}selected{% endif %}>
                      Choose a marketplace
                    </option>
                    {% for market in markets %}
                      <option value="{{ market }}" {% if values.get('market') == market %}selected{% endif %}>
                        {{ market }}
                      </option>
                    {% endfor %}
                  </select>
                </div>
              </label>
              <label>
                <span>SKU / Product Link</span>
                <input
                  name="sku_or_url"
                  placeholder="e.g. SHEIN-329499 or https://..."
                  value="{{ values.get('sku_or_url', '') }}"
                  required
                  type="text"
                />
              </label>
            </div>
            <button type="button" class="ghost-btn" title="Coming soon" disabled>Fetch product data</button>
          </section>

          <section class="card">
            <div class="card-header">
              <h2>Manual product assets</h2>
              <p>Upload a clean product shot when the marketplace does not expose an API.</p>
            </div>
            <label class="dropzone">
              <input type="file" name="product_image" accept="image/*" required />
              <span class="dz-icon">⬆︎</span>
              <p>Drag &amp; drop or click to upload a hero image (PNG, JPG, GIF, WEBP).</p>
            </label>
            <label>
              <span>Product title</span>
              <input
                name="title"
                placeholder="MagSafe-ready Luxury Phone Case"
                value="{{ values.get('title', '') }}"
                required
                type="text"
              />
            </label>
            <label>
              <span>Short description</span>
              <textarea
                name="description"
                placeholder="Add a quick summary or the highlights you love about this listing."
                rows="3"
              >{{ values.get('description', '') }}</textarea>
            </label>
            <label>
              <span>Affiliate link</span>
              <input
                name="affiliate_link"
                placeholder="https://yourstore.com/track?id=..."
                value="{{ values.get('affiliate_link', '') }}"
                required
                type="url"
              />
            </label>
             <div class="form-actions">
              <button class="ghost-btn" type="submit" formaction="{{ url_for('save_product') }}">Save product setup</button>
              <button class="primary" type="submit">Generate for Pinterest</button>
            </div>
          </section>

          <!-- <section class="card">
            <div class="card-header">
              <h2>Pinterest prompt booster</h2>
              <p>Drop any extra angles, seasonal hooks, or CTA copy.</p>
            </div>
            <div class="form-actions">
              <button class="ghost-btn" type="submit" formaction="{{ url_for('save_product') }}">Save product setup</button>
              <button class="primary" type="submit">Generate for Pinterest</button>
            </div>
          </section> -->
        </form>

        <section class="card result">
          <div class="card-header">
            <div class="card-header-text">
              <h2>Pinterest content</h2>
              <p>Boost the prompt, review the visual, and publish when ready.</p>
            </div>
            {{ platform_reset_button('pinterest', 'Pinterest workflow', active_sku) }}
          </div>
          {% if has_preview %}
            <div class="preview-grid">
              <div class="preview-image">
                <img src="data:image/png;base64,{{ preview_data.image_data }}" alt="Generated Pinterest pin preview" />
              </div>
              <div class="preview-meta">
                <form method="post" action="{{ url_for('generate_pinterest') }}" class="stacked-platform-form inline-booster">
                  {{ preview_hidden_inputs(preview_data, values, saved_assets) }}
                  <label class="card-subsection">
                    <span>Pinterest prompt booster</span>
                    <textarea
                      name="pinterest_extra"
                      placeholder="Mention eco-friendly materials, Mother's Day bundles, etc."
                      rows="3"
                    >{{ preview_data.pinterest_extra if preview_data.pinterest_extra else values.get('pinterest_extra', '') }}</textarea>
                  </label>
                  <div class="form-actions">
                    <button class="ghost-btn" type="submit">Regenerate Pinterest visual</button>
                  </div>
                </form>
                <dl>
                  <dt>Title</dt>
                  <dd>{{ preview_data.title }}</dd>
                  <dt>Description</dt>
                  <dd>{{ preview_data.description }}</dd>
                  {% if preview_data.tags %}
                    <dt>Tags</dt>
                    <dd>
                      {% for tag in preview_data.tags %}
                        <span class="tag">{{ tag }}</span>
                      {% endfor %}
                    </dd>
                  {% endif %}
                </dl>
                <div class="preview-actions">
                  <form method="post" action="{{ url_for('confirm_pinterest') }}">
                    {{ preview_hidden_inputs(preview_data, values, saved_assets) }}
                    <button type="submit" class="primary">Confirm &amp; publish to Pinterest</button>
                  </form>
                </div>
              </div>
            </div>
          {% else %}
            <p class="muted">Generate a product visual to unlock publishing on Pinterest, Instagram, TikTok, and YouTube.</p>
          {% endif %}
        </section>

        <section class="card result">
          <div class="card-header">
            <div class="card-header-text">
              <h2>Instagram content</h2>
              <p>Share the same creative on Stories or the feed with platform-ready captions and tags.</p>
            </div>
            {{ platform_reset_button('instagram', 'Instagram content', active_sku) }}
          </div>
          <form method="post" class="stacked-platform-form">
            {{ preview_hidden_inputs(preview_data, values, saved_assets) }}
            <label class="card-subsection">
              <span>Instagram prompt booster</span>
              <textarea
                name="instagram_extra"
                placeholder="Add IG-specific styling cues, seasonal angles, or CTAs."
                rows="3"
              >{{ values.get('instagram_extra', '') }}</textarea>
            </label>
            <div class="platform-grid">
              <div>
                <h3>Visual</h3>
                {% if preview_data.instagram_image_url %}
                  <img
                    class="platform-preview"
                    src="{{ preview_data.instagram_image_url }}"
                    alt="Instagram visual preview"
                  />
                {% elif preview_data.generated_image_url %}
                  <img
                    class="platform-preview"
                    src="{{ preview_data.generated_image_url }}"
                    alt="Instagram visual preview"
                  />
                {% else %}
                  <p class="muted">
                    {% if base_image_available %}
                      Ready to generate. Use the buttons to craft a fresh Instagram visual.
                    {% else %}
                      Save your product data with an image to unlock Instagram visuals.
                    {% endif %}
                  </p>
                {% endif %}
                <h3>Caption</h3>
                {% if preview_data.instagram_caption %}
                  <p class="copy-block">{{ preview_data.instagram_caption | replace('\n', '<br />') | safe }}</p>
                {% else %}
                  <p class="copy-block muted">Generate your first creative to see an Instagram-ready caption.</p>
                {% endif %}
                {% if preview_data.instagram_hashtags %}
                  <h3>Hashtags</h3>
                  <div class="tag-tray">
                    {% for tag in preview_data.instagram_hashtags %}
                      <span class="tag">#{{ tag }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
              <div class="preview-actions">
                <button
                  type="submit"
                  name="instagram_variant"
                  value="feed"
                  formaction="{{ url_for('generate_instagram_image') }}"
                  class="ghost-btn"
                  {% if not instagram_generation_enabled %}disabled{% endif %}
                >
                  Generate feed visual
                </button>
                <button
                  type="submit"
                  name="instagram_variant"
                  value="story"
                  formaction="{{ url_for('generate_instagram_image') }}"
                  class="ghost-btn"
                  {% if not instagram_generation_enabled %}disabled{% endif %}
                >
                  Generate story visual
                </button>
                <button
                  type="submit"
                  name="target"
                  value="feed"
                  formaction="{{ url_for('publish_instagram') }}"
                  class="primary"
                  {% if not instagram_publish_ready %}disabled{% endif %}
                >
                  Publish to Instagram feed
                </button>
                <button
                  type="submit"
                  name="target"
                  value="story"
                  formaction="{{ url_for('publish_instagram') }}"
                  class="ghost-btn"
                  {% if not instagram_publish_ready %}disabled{% endif %}
                >
                  Share as story
                </button>
              </div>
            </div>
          </form>
        </section>
        <section class="card result">
          <div class="card-header">
            <div class="card-header-text">
              <h2>YouTube Shorts</h2>
              <p>Auto-generate a short-form video, review metadata, and push it straight to YouTube.</p>
            </div>
            {{ platform_reset_button('youtube', 'YouTube workflow', active_sku) }}
          </div>
          <form method="post" class="stacked-platform-form">
            {{ preview_hidden_inputs(preview_data, values, saved_assets) }}
            <label class="card-subsection">
              <span>YouTube prompt booster</span>
              <textarea
                name="youtube_extra"
                placeholder="Add hook ideas, CTA focus, or pacing cues for the Short."
                rows="3"
              >{{ values.get('youtube_extra', '') }}</textarea>
            </label>
            <div class="platform-grid">
              <div>
                {% if preview_data.video_url %}
                  <video controls class="video-preview" src="{{ preview_data.video_url }}"></video>
                {% elif video_available %}
                  <p class="muted">Video ready. Generate a new variation or publish it below.</p>
                {% else %}
                  <p class="muted">Use the generate button to create a Short before publishing.</p>
                {% endif %}
                <dl>
                  <dt>Title</dt>
                  <dd>{{ preview_data.youtube_title if preview_data.youtube_title else 'Awaiting creative...' }}</dd>
                  <dt>Description</dt>
                  <dd>{{ preview_data.youtube_description if preview_data.youtube_description else 'Generate a product story to see suggested copy.' }}</dd>
                  {% if preview_data.youtube_keywords %}
                    <dt>Keywords</dt>
                    <dd>
                      {% for keyword in preview_data.youtube_keywords %}
                        <span class="tag">{{ keyword }}</span>
                      {% endfor %}
                    </dd>
                  {% endif %}
                </dl>
              </div>
              <div class="preview-actions">
                <button
                  type="submit"
                  formaction="{{ url_for('generate_platform_video', platform='youtube') }}"
                  class="ghost-btn"
                  {% if not video_generation_enabled %}disabled{% endif %}
                >
                  Generate YouTube Short
                </button>
                <label>
                  <span>Privacy</span>
                  <select name="privacy_status">
                    <option value="public">Public</option>
                    <option value="unlisted" selected>Unlisted</option>
                    <option value="private">Private</option>
                  </select>
                </label>
                <button
                  type="submit"
                  formaction="{{ url_for('publish_youtube') }}"
                  class="primary"
                  {% if not youtube_publish_ready %}disabled{% endif %}
                >
                  Publish to YouTube Shorts
                </button>
              </div>
            </div>
          </form>
        </section>
        <section class="card result">
          <div class="card-header">
            <div class="card-header-text">
              <h2>TikTok drop</h2>
              <p>Leverage the same motion asset and caption to reach TikTok shoppers.</p>
            </div>
            {{ platform_reset_button('tiktok', 'TikTok workflow', active_sku) }}
          </div>
          <form method="post" class="stacked-platform-form">
            {{ preview_hidden_inputs(preview_data, values, saved_assets) }}
            <label class="card-subsection">
              <span>TikTok prompt booster</span>
              <textarea
                name="tiktok_extra"
                placeholder="Call out trending sounds, transitions, or hooks for TikTok."
                rows="3"
              >{{ values.get('tiktok_extra', '') }}</textarea>
            </label>
            <div class="platform-grid">
              <div>
                {% if preview_data.video_url %}
                  <video controls class="video-preview" src="{{ preview_data.video_url }}"></video>
                {% elif video_available %}
                  <p class="muted">Video ready. Generate a new variation or publish it below.</p>
                {% else %}
                  <p class="muted">Generate a video above to unlock TikTok publishing.</p>
                {% endif %}
                <h3>Caption</h3>
                {% if preview_data.tiktok_caption %}
                  <p class="copy-block">{{ preview_data.tiktok_caption | replace('\n', '<br />') | safe }}</p>
                {% else %}
                  <p class="copy-block muted">Generate content to unlock TikTok-ready copy and hashtags.</p>
                {% endif %}
                {% if preview_data.tiktok_hashtags %}
                  <h3>Hashtags</h3>
                  <div class="tag-tray">
                    {% for tag in preview_data.tiktok_hashtags %}
                      <span class="tag">#{{ tag }}</span>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
              <div class="preview-actions">
                <button
                  type="submit"
                  formaction="{{ url_for('generate_platform_video', platform='tiktok') }}"
                  class="ghost-btn"
                  {% if not video_generation_enabled %}disabled{% endif %}
                >
                  Generate TikTok video
                </button>
                <label>
                  <span>Privacy</span>
                  <select name="privacy_level">
                    <option value="PUBLIC" selected>Public</option>
                    <option value="FRIENDS">Friends</option>
                    <option value="PRIVATE">Private</option>
                  </select>
                </label>
                <button
                  type="submit"
                  formaction="{{ url_for('publish_tiktok') }}"
                  class="primary"
                  {% if not tiktok_publish_ready %}disabled{% endif %}
                >
                  Publish to TikTok
                </button>
              </div>
            </div>
          </form>
        </section>

        {% if result %}
          <section class="card result">
            <div class="card-header">
              <h2>Pin ready ✅</h2>
              <p>Gemini visual + Pinterest copy have been dispatched to your board.</p>
            </div>
            <dl>
              <dt>Title</dt>
              <dd>{{ result.title }}</dd>
              <dt>Description</dt>
              <dd>{{ result.description }}</dd>
              {% if result.tags %}
                <dt>Tags</dt>
                <dd>
                  {% for tag in result.tags %}
                    <span class="tag">{{ tag }}</span>
                  {% endfor %}
                </dd>
              {% endif %}
              {% if result.pin_url %}
                <dt>Pin URL</dt>
                <dd><a href="{{ result.pin_url }}" target="_blank" rel="noopener">View on Pinterest</a></dd>
              {% endif %}
            </dl>
          </section>
        {% endif %}
      </main>
    </div>
  </body>
</html>
